{"version":3,"file":"FetchAssociatedFeatureLayer.8646279d.js","sources":["../../node_modules/@arcgis/core/layers/support/FetchAssociatedFeatureLayer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{id as t}from\"../../kernel.js\";import r from\"../../request.js\";import{isNone as e,isSome as a}from\"../../core/maybe.js\";import{throwIfAbortError as i}from\"../../core/promiseUtils.js\";import s from\"../FeatureLayer.js\";import n from\"../../portal/Portal.js\";import o from\"../../portal/PortalItem.js\";class l{constructor(t,r,e,a){this.parsedUrl=t,this.portalItem=r,this.apiKey=e,this.signal=a,this.rootDocument=null;const i=this.parsedUrl.path.match(/^(.*)\\/SceneServer\\/layers\\/([\\d]*)\\/?$/i);i&&(this.urlParts={root:i[1],layerId:parseInt(i[2],10)})}async fetch(){var t;if(!this.urlParts)return null;const r=null!=(t=this.portalItem)?t:await this.portalItemFromServiceItemId();if(e(r))return this.loadFromUrl();const a=await this.findAndLoadRelatedPortalItem(r);return e(a)?null:this.loadFeatureLayerFromPortalItem(a)}async fetchPortalItem(){var t;if(!this.urlParts)return null;const r=null!=(t=this.portalItem)?t:await this.portalItemFromServiceItemId();return e(r)?null:this.findAndLoadRelatedPortalItem(r)}async fetchRootDocument(){if(a(this.rootDocument))return this.rootDocument;if(e(this.urlParts))return this.rootDocument={},{};const t={query:{f:\"json\",token:this.apiKey},responseType:\"json\",signal:this.signal},i=`${this.urlParts.root}/SceneServer`;try{const e=await r(i,t);this.rootDocument=e.data}catch{this.rootDocument={}}return this.rootDocument}async fetchServiceOwningPortalUrl(){var e;const a=null==(e=t)?void 0:e.findServerInfo(this.parsedUrl.path);if(null!=a&&a.owningSystemUrl)return a.owningSystemUrl;const s=this.parsedUrl.path.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\";try{const t=(await r(s,{query:{f:\"json\"},responseType:\"json\",signal:this.signal})).data.owningSystemUrl;if(t)return t}catch(n){i(n)}return null}async findAndLoadRelatedPortalItem(t){try{return(await t.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:this.signal})).find((t=>\"Feature Service\"===t.type))||null}catch(r){return i(r),null}}async loadFeatureLayerFromPortalItem(t){await t.load({signal:this.signal});const r=await this.findMatchingAssociatedSublayerUrl(t.url);return new s({url:r,portalItem:t}).load({signal:this.signal})}async loadFromUrl(){const t=await this.findMatchingAssociatedSublayerUrl(`${this.urlParts.root}/FeatureServer`);return new s({url:t}).load({signal:this.signal})}async findMatchingAssociatedSublayerUrl(t){const e=t.replace(/^(.*FeatureServer)(\\/[\\d]*\\/?)?$/i,\"$1\"),a={query:{f:\"json\"},responseType:\"json\",authMode:\"no-prompt\",signal:this.signal},i=this.urlParts.layerId,s=this.fetchRootDocument(),n=r(e,a),[o,l]=await Promise.all([n,s]),c=l&&l.layers,h=o.data&&o.data.layers;if(!Array.isArray(h))throw new Error(\"expected layers array\");if(Array.isArray(c))for(let r=0;r<Math.min(c.length,h.length);r++){if(c[r].id===i)return`${e}/${h[r].id}`}else if(i<h.length)return`${e}/${h[i].id}`;throw new Error(\"could not find matching associated sublayer\")}async portalItemFromServiceItemId(){const t=(await this.fetchRootDocument()).serviceItemId;if(!t)return null;const r=new o({id:t,apiKey:this.apiKey}),e=await this.fetchServiceOwningPortalUrl();a(e)&&(r.portal=new n({url:e}));try{return r.load({signal:this.signal})}catch(s){return i(s),null}}}export{l as FetchAssociatedFeatureLayer};\n"],"names":["t","e","a","r","i","s","o","n"],"mappings":"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"}