var D=Object.defineProperty,M=Object.defineProperties;var T=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var I=(a,e,t)=>e in a?D(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,j=(a,e)=>{for(var t in e||(e={}))L.call(e,t)&&I(a,t,e[t]);if(P)for(var t of P(e))O.call(e,t)&&I(a,t,e[t]);return a},E=(a,e)=>M(a,T(e));import{D as o,E as n,g7 as R,J as F,v as S,m as u,ax as G,cc as Q}from"./externalRenderers.e9b2a64d.js";import{V as _}from"./DynamicLayerView3D.71dffdde.js";import{c as $}from"./ExportImageParameters.6811c936.js";import{s as q}from"./clickToleranceUtils.f03f410d.js";import{t as z,d as H}from"./popupUtils.b610e8fc.js";import{n as N}from"./floorFilterUtils.1acb5b5d.js";import{a as k}from"./drapedUtils.cf000b28.js";import"./projectExtentUtils.30ddc74f.js";import"./ImageMaterialTechnique.ca20af60.js";import"./RefreshableLayerView.c7d5f29e.js";import"./sublayerUtils.5227ee88.js";const J=a=>{let e=class extends a{initialize(){this.exportImageParameters=new $({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,l){const{layer:d}=this;if(!t)return Promise.reject(new S("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:d}));const y=this.get("view.scale"),h=[],f=async r=>{const i=r.minScale===0||y<=r.minScale,s=r.maxScale===0||y>=r.maxScale;if(r.visible&&i&&s){if(r.sublayers)r.sublayers.forEach(f);else if(r.popupEnabled){const p=H(r,E(j({},l),{defaultPopupTemplateEnabled:!1}));u(p)&&h.unshift({sublayer:r,popupTemplate:p})}}},V=d.sublayers.toArray().reverse().map(f);await Promise.all(V);const A=h.map(async({sublayer:r,popupTemplate:i})=>{await r.load().catch(()=>{});const s=r.createQuery(),p=u(l)?l.event:null,g=q({renderer:r.renderer,event:p}),x=this.createFetchPopupFeaturesQueryGeometry(t,g);if(s.geometry=x,s.outFields=await z(r,i),this.layer.type==="map-image"&&"floors"in this.view){var w,v;const U=(w=this.view)==null||(v=w.floors)==null?void 0:v.clone(),m=N(U,r);u(m)&&(s.where=s.where?`(${s.where}) AND (${m})`:m)}const b=await this._loadArcadeModules(i);return b&&b.arcadeUtils.hasGeometryOperations(i)||(s.maxAllowableOffset=x.width/g),(await r.queryFeatures(s)).features});return(await G(A)).reduce((r,i)=>i.value?[...r,...i.value]:r,[]).filter(r=>r!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(l=>l.type==="expression"))return Q()}};return o([n()],e.prototype,"exportImageParameters",void 0),o([n({readOnly:!0})],e.prototype,"exportImageVersion",null),o([n()],e.prototype,"layer",void 0),o([n()],e.prototype,"suspended",void 0),o([n(R)],e.prototype,"timeExtent",void 0),e=o([F("esri.views.layers.MapImageLayerView")],e),e};let c=class extends J(_){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(this,"exportImageVersion",()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(a,e){return k(a,e,this.view)}getFetchOptions(){return{timeExtent:this.timeExtent}}};c=o([F("esri.views.3d.layers.MapImageLayerView3D")],c);const ie=c;export{ie as default};
//# sourceMappingURL=MapImageLayerView3D.82719e04.js.map
