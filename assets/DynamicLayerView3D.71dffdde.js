var U=Object.defineProperty,W=Object.defineProperties;var k=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var P=(t,e,a)=>e in t?U(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a,y=(t,e)=>{for(var a in e||(e={}))B.call(e,a)&&P(t,a,e[a]);if(T)for(var a of T(e))X.call(e,a)&&P(t,a,e[a]);return t},q=(t,e)=>W(t,k(e));import{cF as w,cG as _,cH as J,cI as N,cJ as Q,cK as K,cL as Y,cM as Z,cN as ee,cO as te,cP as ae,cQ as ie,cR as se,M as D,cC as re,cD as ne,aA as oe,X as C,U as G,cS as le,cf as E,ax as he,ab as L,cT as ce,cU as ue,aO as de,aQ as me,aT as H,ck as A,cV as ge,m as F,cW as pe,ay as fe,ae as z,cX as ye,cY as xe,bX as we,D as x,E as v,J as _e}from"./externalRenderers.e9b2a64d.js";import{l as ve}from"./projectExtentUtils.30ddc74f.js";import{O as be,E as Se}from"./ImageMaterialTechnique.ca20af60.js";import{i as Re}from"./RefreshableLayerView.c7d5f29e.js";function Ce(t,e,a){const s=w(t)/_(t),i={width:a,height:a};return s>1.0001?i.height=a/s:s<.9999&&(i.width=a*s),i.width=Math.round(i.width/(w(t)/w(e))),i.height=Math.round(i.height/(_(t)/_(e))),i}function j(t){return J.createSquareGeometry([[t[0],t[1],-1],[t[2],t[1],-1],[t[2],t[3],-1],[t[0],t[3],-1]])}function Ee(t,e){if(!N(t,e))return j(e);const a=[t[1]-e[1],Math.min(t[3],e[3])-Math.max(t[1],e[1]),e[3]-t[3],123456],s=[t[0]-e[0],Math.min(t[2],e[2])-Math.max(t[0],e[0]),e[2]-t[2],123456],i=e[2]-e[0],o=e[3]-e[1],n=s[0]>0&&s[2]>0?3:2,r=a[0]>0&&a[2]>0?3:2,c=(r+1)*(n+1),l=new Float64Array(3*c),u=new Float32Array(2*c),h=new Uint32Array(6*(r*n-1));let b=0,S=0,M=0,d=0,g=0;for(let p=0;p<4;p++){const I=a[p];if(I<=0)continue;let R=0;for(let f=0;f<4;f++){const O=s[f];O<=0||(l[S++]=e[0]+R,l[S++]=e[1]+b,l[S++]=-1,u[M++]=R/i,u[M++]=b/o,f<3&&p<3&&(f!==1||p!==1)&&(h[g++]=d,h[g++]=d+1,h[g++]=d+n+1,h[g++]=d+1,h[g++]=d+n+2,h[g++]=d+n+1),d++,R+=O)}b+=I}const V=new Uint32Array(h.length);return new Q([["position",{size:3,data:l,exclusive:!0}],["normal",{size:3,data:Ae,exclusive:!0}],["uv0",{size:2,data:u,exclusive:!0}]],[["position",h],["normal",V],["uv0",h]])}const Ae=[0,0,1];class $e extends K{constructor(e){super(e,Ie),this.supportsEdges=!0,this.techniqueConfig=new be}getTechniqueConfig(e,a){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=a.transparencyPassType,this.techniqueConfig.enableOffset=a.camera.relativeElevation<Y,this.techniqueConfig.multipassTerrainEnabled=a.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=a.cullAboveGround,this.techniqueConfig}intersect(e,a,s,i,o,n,r){Z(e,a,i,o,n,void 0,r)}requiresSlot(e,a){return e===20?!0:ee(a)===4?e===2:e===(this.parameters.transparent?this.parameters.writeDepth?4:7:2)}createGLMaterial(e){return e.output===0||e.output===7||e.output===4?new Me(e):void 0}createBufferWriter(){return new te(ae)}}class Me extends ie{constructor(e){super(y(y({},e),e.material.parameters))}updateParameters(e){const a=this._material.parameters;return this.updateTexture(a.textureId),this.ensureTechnique(Se,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&(this._material.setParameters({sceneHasOcludees:e.hasOccludees}),this.updateParameters(e))}beginSlot(e){return this._output!==0&&this._output!==7||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,a){this.bindTextures(a.program),this.bindTextureScale(a.program),a.bindPass(this._material.parameters,e)}}const Ie=y({transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,opacity:1,textureId:null,initTextureTransparent:!0},se),$=D.getLogger("esri.views.3d.layers.DynamicLayerView3D");let m=class extends Re(re(ne)){constructor(){super(...arguments),this.drapeSourceType=0,this.updatePolicy=1,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this.updateWhenStationary=!0,this.refreshDebounced=oe(async t=>{this.destroyed||await this._doRefresh(t).catch(e=>{C(e)||D.getLogger(this.declaredClass).error(e)})},2e3)}initialize(){this.addResolvingPromise(ve(this).then(t=>this._set("fullExtentInLocalViewSpatialReference",t))),this.updatingHandles.add(this,"suspended",()=>this._suspendedChangeHandler()),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{})),this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,"scaleRangeId",()=>this.notifyChange("suspended"))}destroy(){this.clear()}setDrapingExtent(t,e){this._spatialReference=e,t.forEach(a=>{this._overlays[a.index]=a,this._updateImageExtent(a)})}_updateImageExtent(t){const e=this._clippedExtent(t.extent,Oe);if(G(e))return;const a=Ce(t.extent,e,t.resolution);let s=t.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){const o=this.layer.imageMaxWidth,n=this.layer.imageMaxHeight;if(a.width>o){const r=o/a.width;a.height=Math.floor(a.height*r),a.width=o,s*=r}if(a.height>n){const r=n/a.height;a.width=Math.floor(a.width*r),a.height=n,s*=r}}const i=this._extents[t.index];i&&le(i.extent,e)&&this._imageSizeEquals(e,i.imageSize,a)||(this._extents[t.index]={extent:E(e),imageSize:a,pixelRatio:s},this.suspended||this._fetch(t.index).catch(o=>{C(o)||$.error(o)}))}clear(){for(let t=0;t<this._images.length;t++)this._clearImage(t)}async doRefresh(){return this._doRefresh()}async _doRefresh(t){if(this.suspended)return;const e=[];for(let a=0;a<this._extents.length;a++)this._extents[a]&&e.push(this._fetch(a,t));await he(e)}canResume(){if(!super.canResume())return!1;if(this._isScaleRangeLayer()){const{minScale:t,maxScale:e}=this.layer;if(t>0||e>0){const a=this.view.scale;if(a<e||t>0&&a>t)return!1}}return!0}isUpdating(){return this._images.some(t=>!!t.loadingPromise)}async processResult(t,e,a){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(t.image=e)}findExtentInfoAt(t){for(const e of this._extents){const a=e.extent;if(new L(a[0],a[1],a[2],a[3],this._spatialReference).contains(t))return e}return null}getFetchOptions(){}async redraw(t,e){await ce(this._images,async(a,s)=>{a&&(await t(a,e),await this._createStageObjects(s,a.image,e))})}_imageSizeEquals(t,e,a){if(!this.maximumDataResolution)return!1;const s=w(t)/this.maximumDataResolution.x,i=_(t)/this.maximumDataResolution.y,o=s/e.width,n=i/e.height,r=s/a.width,c=i/a.height,l=Math.abs(o-r),u=Math.abs(n-c),h=ue.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return l<=h&&u<=h}async _fetch(t,e){if(this.suspended)return;const a=this._extents[t],s=a.extent;this._images[t]||(this._images[t]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:E(s)});const i=this._images[t];i.loadingAbortController&&(i.loadingAbortController.abort(),i.loadingAbortController=null);const o=new L(s[0],s[1],s[2],s[3],this._spatialReference);if(o.width===0||o.height===0)return void this._clearImage(t);const n=new AbortController;i.loadingAbortController=n,de(e,()=>n.abort());const r=n.signal,c=this._waitFetchReady(r).then(()=>{const l=q(y({requestAsImageElement:!0,pixelRatio:this._overlays[t].pixelRatio},this.getFetchOptions()),{signal:r}),{height:u,width:h}=a.imageSize;return this.layer.fetchImage(o,h,u,l)}).then(l=>{if(me(r))throw $.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),H();return this.processResult(i,l)}).then(()=>A(i.renderExtent,s));i.loadingPromise=c,ge(c,()=>{c===i.loadingPromise&&(i.loadingPromise=null,i.loadingAbortController=null)}),this.notifyChange("updating"),await c.then(async()=>{if(r.aborted)throw H();await this._createStageObjects(t,i.image,r),this.notifyChange("updating")}).catch(l=>{throw l&&!C(l)&&$.error(l),this.notifyChange("updating"),l})}_clearImage(t){const e=this._images[t];if(e){F(e.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([e.renderGeometry],this,2),e.renderGeometry=null);const a=this.view._stage;a.remove(e.texture),e.texture=null,a.remove(e.material),e.material=null,e.loadingAbortController&&(e.loadingAbortController.abort(),e.loadingAbortController=null),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(t,e,a){const s=this.view._stage,i=this._images[t],o=this.view.basemapTerrain.overlayManager.renderer,n=()=>{s.remove(i.texture),i.texture=null,F(i.renderGeometry)&&(o.removeGeometries([i.renderGeometry],this,2),i.renderGeometry=null)};if(e){const r=new pe(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});let c;if(await fe(this._images[t===0?1:0].loadingPromise),z(a),t===0)c=j(i.renderExtent);else{const l=this._images[0].renderExtent;if(!l)return void n();c=Ee(l,i.renderExtent)}n(),s.add(r),s.loadSynchronous(r),i.texture=r,G(i.material)?(i.material=new $e({transparent:!0,textureId:r.id}),s.add(i.material)):i.material.setParameters({textureId:r.id}),i.renderGeometry=new ye(c,i.material),i.renderGeometry.origin=this._overlays[t].renderLocalOrigin,o.addGeometries([i.renderGeometry],this,2)}else n(),s.remove(i.material),i.material=null}_isScaleRangeLayer(){return"minScale"in this.layer&&"maxScale"in this.layer}_isScaleRangeActive(){return!!this._isScaleRangeLayer()&&(this.layer.minScale>0||this.layer.maxScale>0)}_clippedExtent(t,e){if(this.view.viewingMode!=="local")return A(e,t);const a=this.view.basemapTerrain;return a.ready?xe(t,a.extent,e):A(e,t)}_suspendedChangeHandler(){this.suspended?this.clear():this.refreshDebounced()}async _waitFetchReady(t){await we(this.view,"stationary",t),z(t)}};x([v()],m.prototype,"layer",void 0),x([v()],m.prototype,"suspended",void 0),x([v({readOnly:!0})],m.prototype,"fullExtentInLocalViewSpatialReference",void 0),x([v()],m.prototype,"updating",void 0),m=x([_e("esri.views.3d.layers.DynamicLayerView3D")],m);const Oe=E(),Le=m;export{Le as V};
//# sourceMappingURL=DynamicLayerView3D.71dffdde.js.map
