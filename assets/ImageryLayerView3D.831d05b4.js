import{D as o,E as d,g7 as E,J as u,v as h,m as c,S as b,c0 as y,aA as j,bX as I,U as w}from"./externalRenderers.e9b2a64d.js";import{V as T}from"./DynamicLayerView3D.71dffdde.js";import{d as P}from"./popupUtils.b610e8fc.js";import"./projectExtentUtils.30ddc74f.js";import"./ImageMaterialTechnique.ca20af60.js";import"./RefreshableLayerView.c7d5f29e.js";const F=t=>{let e=class extends t{constructor(){super(...arguments),this.view=null}async fetchPopupFeatures(a,r){const{layer:n}=this;if(!a)throw new h("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:n});const{popupEnabled:i}=n,s=P(n,r);if(!i||!c(s))throw new h("imagerylayerview:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:i,popupTemplate:s});const g=await s.getRequiredFields(),l=new b;l.timeExtent=this.timeExtent,l.geometry=a,l.outFields=g,l.outSpatialReference=a.spatialReference;const p=this.view.resolution,f=this.view.type==="2d"?new y(p,p,this.view.spatialReference):new y(.5*p,.5*p,this.view.spatialReference),{returnTopmostRaster:x,showNoDataRecords:R}=s.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},v={returnDomainValues:!0,returnTopmostRaster:x,pixelSize:f,showNoDataRecords:R,signal:c(r)?r.signal:null};return n.queryVisibleRasters(l,v).then(D=>D)}canResume(){var a;return!!super.canResume()&&((a=this.timeExtent)==null||!a.isEmpty)}};return o([d()],e.prototype,"layer",void 0),o([d()],e.prototype,"suspended",void 0),o([d(E)],e.prototype,"timeExtent",void 0),o([d()],e.prototype,"view",void 0),e=o([u("esri.views.layers.ImageryLayerView")],e),e};let m=class extends F(T){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=j(async t=>{this.redraw((e,a)=>this._redrawImage(e,a),t)},2e3)}initialize(){this.handles.add([I(this.view.basemapTerrain,"ready",()=>this.initializeMaximumDataResolution()),this.layer.on("redraw",()=>this.redrawDebounced())]),this.updatingHandles.add(this.layer,"exportImageServiceParameters.version",()=>{this.updatingHandles.addPromise(this.refreshDebounced())}),this.updatingHandles.add(this,"timeExtent",()=>this.updatingHandles.addPromise(this.refreshDebounced()))}initializeMaximumDataResolution(){const t=this.view.basemapTerrain.spatialReference,e=this.layer.fullExtent;e&&t.equals(e.spatialReference)&&(this.maximumDataResolution={x:this.layer.pixelSizeX,y:this.layer.pixelSizeY})}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(t,e,a){e.imageElement?t.image=e.imageElement:(t.image=document.createElement("canvas"),t.pixelData=e.pixelData,await this._redrawImage(t,a))}async _redrawImage(t,e){if(!(t.image instanceof HTMLCanvasElement)||w(t.pixelData))return Promise.reject();const a=t.image,r=a.getContext("2d"),n=await this.layer.applyRenderer(t.pixelData,{signal:e}),i=this.layer.applyFilter(n).pixelBlock;if(w(i))return Promise.reject();a.width=i.width,a.height=i.height;const s=r.createImageData(i.width,i.height);s.data.set(i.getAsRGBA()),r.putImageData(s,0,0)}};m=o([u("esri.views.3d.layers.ImageryLayerView3D")],m);const M=m;export{M as default};
//# sourceMappingURL=ImageryLayerView3D.831d05b4.js.map
