{"version":3,"file":"WFSSourceWorker.1459d209.js","sources":["../../node_modules/@arcgis/core/layers/graphics/sources/WFSSourceWorker.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport e from\"../../../core/Error.js\";import t from\"../../../core/Logger.js\";import{isSome as r,unwrap as s}from\"../../../core/maybe.js\";import{throwIfAborted as a,createTask as i,isAbortError as n}from\"../../../core/promiseUtils.js\";import{equals as o,WGS84 as u}from\"../../../geometry/support/spatialReferenceUtils.js\";import{convertFromGeometry as p,convertToGeometry as h}from\"../featureConversionUtils.js\";import y from\"../data/FeatureStore.js\";import{project as l,checkProjectionSupport as c}from\"../data/projectionSupport.js\";import m from\"../data/QueryEngine.js\";import{validateGeoJSON as g,createOptimizedFeatures as _}from\"./geojson/geojson.js\";import{mixAttributes as f}from\"./support/sourceUtils.js\";import{getFeature as d}from\"../../ogc/wfsUtils.js\";import w from\"../../support/FieldsIndex.js\";class E{constructor(){this._queryEngine=null,this._customParameters=null,this._snapshotFeatures=async e=>{const{objectIdField:t}=this._queryEngine,s=await d(this._getFeatureUrl,this._featureType.typeName,this._getFeatureOutputFormat,{customParameters:this._customParameters,dateFields:this._queryEngine.fieldsIndex.dateFields.map((e=>e.name)),signal:e});await g(s),a(e);const i=_(s,{geometryType:this._queryEngine.geometryType,hasZ:!1,objectIdField:t});if(!o(this._queryEngine.spatialReference,u))for(const a of i)r(a.geometry)&&(a.geometry=p(l(h(a.geometry,this._queryEngine.geometryType,!1,!1),u,this._queryEngine.spatialReference)));let n=1;for(const r of i){const e={};f(this._fieldsIndex,e,r.attributes,!0),r.attributes=e,null==r.attributes[t]&&(r.objectId=r.attributes[t]=n++)}return i}}destroy(){var e;null==(e=this._queryEngine)||e.destroy(),this._queryEngine=null}async load(e,t){const{getFeatureUrl:r,getFeatureOutputFormat:i,spatialReference:n,fields:o,geometryType:u,featureType:p,objectIdField:h,customParameters:l}=e;this._featureType=p,this._customParameters=l,this._getFeatureUrl=r,this._getFeatureOutputFormat=i,this._fieldsIndex=new w(o),await this._checkProjection(n),a(t),this._queryEngine=new m({fields:o,geometryType:u,hasM:!1,hasZ:!1,objectIdField:h,spatialReference:n,timeInfo:null,featureStore:new y({geometryType:u,hasM:!1,hasZ:!1})});const c=await this._snapshotFeatures(s(t.signal));return this._queryEngine.featureStore.addMany(c),{extent:this._queryEngine.fullExtent}}async applyEdits(){throw new e(\"wfs-source:editing-not-supported\",\"applyEdits() is not supported on WFSLayer\")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(r){var s;return this._customParameters=r,null==(s=this._snapshotTask)||s.abort(),this._snapshotTask=i(this._snapshotFeatures),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(r=>{this._queryEngine.featureStore.clear(),n(r)||t.getLogger(\"esri.layers.WFSLayer\").error(new e(\"wfs-layer:getfeature-error\",\"An error occurred during the GetFeature request\",{error:r}))})),await this._waitSnapshotComplete(),{extent:this._queryEngine.fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _checkProjection(t){try{await c(u,t)}catch{throw new e(\"unsupported-projection\",\"Projection not supported\",{spatialReference:t})}}}export{E as default};\n"],"names":["d","g","a","_","o","u","p","l","h","f","e","w","m","y","s","i","n","t","c"],"mappings":"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"}