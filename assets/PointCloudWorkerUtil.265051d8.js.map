{"version":3,"file":"PointCloudWorkerUtil.265051d8.js","sources":["../../node_modules/@arcgis/core/views/3d/layers/i3s/PointCloudWorkerUtil.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{isNone as e,isSome as o}from\"../../../../core/maybe.js\";import r from\"../../../../renderers/PointCloudClassBreaksRenderer.js\";import t from\"../../../../renderers/PointCloudStretchRenderer.js\";import n from\"../../../../renderers/PointCloudUniqueValueRenderer.js\";import{createGeometryIndexFromSchema as l,createTypedView as i,readBinaryAttribute as s}from\"./I3SBinaryReader.js\";import{decodeXYZ as f}from\"./LEPCC.js\";function u(e,o,l,i){const{rendererJSON:s,isRGBRenderer:f}=e;let u=null,c=null;if(o&&f)u=o;else if(o&&\"pointCloudUniqueValueRenderer\"===s.type){c=n.fromJSON(s);const e=c.colorUniqueValueInfos;u=new Uint8Array(3*i);const r=p(c.fieldTransformType);for(let t=0;t<i;t++){const n=(r?r(o[t]):o[t])+\"\";for(let o=0;o<e.length;o++)if(e[o].values.indexOf(n)>=0){u[3*t]=e[o].color.r,u[3*t+1]=e[o].color.g,u[3*t+2]=e[o].color.b;break}}}else if(o&&\"pointCloudStretchRenderer\"===s.type){c=t.fromJSON(s);const e=c.stops;u=new Uint8Array(3*i);const r=p(c.fieldTransformType);for(let t=0;t<i;t++){const n=r?r(o[t]):o[t],l=e.length-1;if(n<e[0].value)u[3*t]=e[0].color.r,u[3*t+1]=e[0].color.g,u[3*t+2]=e[0].color.b;else if(n>=e[l].value)u[3*t]=e[l].color.r,u[3*t+1]=e[l].color.g,u[3*t+2]=e[l].color.b;else for(let o=1;o<e.length;o++)if(n<e[o].value){const r=(n-e[o-1].value)/(e[o].value-e[o-1].value);u[3*t]=e[o].color.r*r+e[o-1].color.r*(1-r),u[3*t+1]=e[o].color.g*r+e[o-1].color.g*(1-r),u[3*t+2]=e[o].color.b*r+e[o-1].color.b*(1-r);break}}}else if(o&&\"pointCloudClassBreaksRenderer\"===s.type){c=r.fromJSON(s);const e=c.colorClassBreakInfos;u=new Uint8Array(3*i);const t=p(c.fieldTransformType);for(let r=0;r<i;r++){const n=t?t(o[r]):o[r];for(let o=0;o<e.length;o++)if(n>=e[o].minValue&&n<=e[o].maxValue){u[3*r]=e[o].color.r,u[3*r+1]=e[o].color.g,u[3*r+2]=e[o].color.b;break}}}else{u=new Uint8Array(3*i);for(let e=0;e<u.length;e++)u[e]=255}if(l&&c&&c.colorModulation){const e=c.colorModulation.minValue,o=c.colorModulation.maxValue,r=.3;for(let t=0;t<i;t++){const n=l[t],i=n>=o?1:n<=e?r:r+(1-r)*(n-e)/(o-e);u[3*t]=i*u[3*t],u[3*t+1]=i*u[3*t+1],u[3*t+2]=i*u[3*t+2]}}return u}function c(o,r){if(null==o.encoding||\"\"===o.encoding){const t=l(r,o);if(e(t.vertexAttributes.position))return;const n=i(r,t.vertexAttributes.position),s=t.header.fields,f=[s.offsetX,s.offsetY,s.offsetZ],u=[s.scaleX,s.scaleY,s.scaleZ],c=n.length/3,a=new Float64Array(3*c);for(let e=0;e<c;e++)a[3*e]=n[3*e]*u[0]+f[0],a[3*e+1]=n[3*e+1]*u[1]+f[1],a[3*e+2]=n[3*e+2]*u[2]+f[2];return a}if(\"lepcc-xyz\"===o.encoding)return f(r).result}function a(e,r,t){return o(e)&&e.attributeInfo.useElevation?d(r,t):o(e)?s(e.attributeInfo.storageInfo,e.buffer,t):null}function d(e,o){const r=new Float64Array(o);for(let t=0;t<o;t++)r[t]=e[3*t+2];return r}function m(e,o,r,t,n){const l=e.length/3;let i=0;for(let s=0;s<l;s++){let l=!0;for(let e=0;e<t.length&&l;e++){const{filterJSON:o}=t[e],r=n[e].values[s];switch(o.type){case\"pointCloudValueFilter\":{const e=\"exclude\"===o.mode;-1!==o.values.indexOf(r)===e&&(l=!1);break}case\"pointCloudBitfieldFilter\":{const e=b(o.requiredSetBits),t=b(o.requiredClearBits);(r&e)===e&&0==(r&t)||(l=!1);break}case\"pointCloudReturnFilter\":{const e=15&r,t=r>>>4&15,n=t>1,i=1===e,s=e===t;let f=!1;for(const r of o.includedReturns)if(\"last\"===r&&s||\"firstOfMany\"===r&&i&&n||\"lastOfMany\"===r&&s&&n||\"single\"===r&&!n){f=!0;break}f||(l=!1);break}}}l&&(r[i]=s,e[3*i]=e[3*s],e[3*i+1]=e[3*s+1],e[3*i+2]=e[3*s+2],o[3*i]=o[3*s],o[3*i+1]=o[3*s+1],o[3*i+2]=o[3*s+2],i++)}return i}function p(e){return null==e||\"none\"===e?null:\"low-four-bit\"===e?e=>15&e:\"high-four-bit\"===e?e=>(240&e)>>4:\"absolute-value\"===e?e=>Math.abs(e):\"modulo-ten\"===e?e=>e%10:null}function b(e){let o=0;for(const r of e||[])o|=1<<r;return o}export{d as elevationFromPositions,u as evaluateRenderer,m as filterInPlace,a as getAttributeValues,c as readGeometry};\n"],"names":["n","t","r","l","e","i","f","o","s"],"mappings":"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"}