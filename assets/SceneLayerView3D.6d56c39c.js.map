{"version":3,"file":"SceneLayerView3D.6d56c39c.js","sources":["../../node_modules/@arcgis/core/views/3d/layers/SceneLayerView3D.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../Graphic.js\";import r from\"../../../core/Logger.js\";import{isSome as i,isNone as s,destroyMaybe as o}from\"../../../core/maybe.js\";import{property as n}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/arrayUtils.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as l}from\"../../../core/accessorSupport/decorators/subclass.js\";import{WhereClause as a}from\"../../../core/sql/WhereClause.js\";import u from\"../../../layers/support/FeatureFilter.js\";import d from\"../../../rest/support/Query.js\";import{I3SMeshView3D as p}from\"./I3SMeshView3D.js\";import{LayerView3D as h}from\"./LayerView3D.js\";import{createInteractiveEditSession as c,processAttributeEdits as y}from\"./i3s/attributeEditing.js\";import{createGetFeatureExtent as f}from\"./i3s/I3SGeometryUtil.js\";import{I3SMeshViewFilter as g}from\"./i3s/I3SMeshViewFilter.js\";import m from\"./i3s/I3SQueryEngine.js\";import{I3SQueryFeatureAdapter as F}from\"./i3s/I3SQueryFeatureAdapter.js\";import v from\"./i3s/I3SQueryFeatureStore.js\";import{getIndexCrs as w}from\"./i3s/I3SUtil.js\";import{DefinitionExpressionSceneLayerView as _}from\"./support/DefinitionExpressionSceneLayerView.js\";import{defineFieldProperties as S}from\"./support/fieldProperties.js\";import{PopupSceneLayerView as j}from\"./support/PopupSceneLayerView.js\";import{SceneLayerViewRequiredFields as E}from\"./support/SceneLayerViewRequiredFields.js\";import{updatingProgress as I}from\"../support/updatingProperties.js\";import b from\"../../layers/SceneLayerView.js\";import{getFloorFilterClause as x}from\"../../support/floorFilterUtils.js\";import{TaskPriority as C}from\"../../support/Scheduler.js\";const Q=r.getLogger(\"esri.views.3d.layers.SceneLayerView3D\"),q=S();let D=class extends(p(_(j(h(b))))){constructor(){super(...arguments),this.type=\"scene-layer-3d\",this.lodFactor=1,this.progressiveLoadFactor=1,this._elevationContext=\"scene\",this._isIntegratedMesh=!1,this._supportsLabeling=!0,this._interactiveEditingSessions=new Map,this._queryEngine=null}get filter(){return i(this.viewFilter)?this.viewFilter.filter:null}set filter(e){!s(e)&&g.checkSupport(e)?i(this.viewFilter)?this.viewFilter.filter=e:this.viewFilter=new g({filter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError)}):this.viewFilter=null}get requiredFields(){var e,t;return null!=(e=null==(t=this.fieldsHelper)?void 0:t.requiredFields)?e:[]}get floorFilterClause(){const e=x(this);return i(e)?a.create(e,this.layer.fieldsIndex):null}get lodCrossfadeinDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService[\"3dObject\"].lodCrossfadeinDuration)?e:0}get lodCrossfadeoutDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService[\"3dObject\"].lodCrossfadeoutDuration)?e:0}get lodCrossfadeUncoveredDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService[\"3dObject\"].lodCrossfadeUncoveredDuration)?e:0}initialize(){this.fieldsHelper=new E({layerView:this}),this.updatingHandles.add(this.layer,\"rangeInfos\",(e=>this._rangeInfosChanged(e)),2),this.updatingHandles.add(this.layer,\"renderer\",(e=>this.updatingHandles.addPromise(this._rendererChange(e))),2);for(const e of[\"parsedDefinitionExpression\",\"filter\",\"viewFilter.parsedWhereClause\",\"viewFilter.parsedGeometry\",\"viewFilter.sortedObjectIds\",\"floorFilterClause\"])this.updatingHandles.add(this,e,(()=>this._filterChange()));for(const e of[\"filter\",\"viewFilter.parsedGeometry\"])this.updatingHandles.add(this,e,(()=>this._geometryFilterChange()));this.handles.add(this.layer.on(\"apply-edits\",(e=>this.updatingHandles.addPromise(e.result)))),this.handles.add(this.layer.on(\"edits\",(e=>this._handleEdits(e))))}destroy(){this.fieldsHelper=o(this.fieldsHelper)}_rangeInfosChanged(e){null!=e&&e.length>0&&Q.warn(\"Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.\")}createQuery(){const e={outFields:[\"*\"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return i(this.filter)?this.filter.createQuery(e):new d(e)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==t?void 0:t.signal).then((e=>{if(null==e||!e.features)return e;const t=this.layer;for(const r of e.features)r.layer=t,r.sourceLayer=t;return e}))}queryObjectIds(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}_ensureQueryEngine(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){const e=f(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new m({layerView:this,priority:C.FEATURE_QUERY_ENGINE,spatialIndex:new v({featureAdapter:new F({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,r,i)=>e({id:t,index:r,meta:i})),t,2),getFeatureExtent:e,sourceSpatialReference:w(this.layer),viewSpatialReference:this.view.spatialReference})})}highlight(e){const t=this._highlights;if(e instanceof d){const{set:r,handle:i}=t.acquireSet();return this.queryObjectIds(e).then((e=>t.setFeatureIds(r,e))),i}return super.highlight(e)}createInteractiveEditSession(e){return c(this.attributeEditingContext,e)}_createLayerGraphic(e){const r=new t(null,null,e);return r.layer=this.layer,r.sourceLayer=this.layer,r}canResume(){return super.canResume()&&(!this._controller||this._controller.rootNodeVisible)}getFilters(){const e=super.getFilters();return this.floorFilterClause&&this.addSqlFilter(e,this.floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),i(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}_ensureQuery(e){return this._addDefinitionExpressionToQuery(s(e)?this.createQuery():d.from(e))}get attributeEditingContext(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:e=>this._forAllNodes((t=>i(t)?e(t.node,t.featureIds):null)),attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this.attributeOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}_handleEdits(e){y(this.attributeEditingContext,e)}get hasGeometryFilter(){const e=this.viewFilter;return i(e)&&i(e.parsedGeometry)}computeNodeFiltering(e){const t=this.viewFilter;return s(t)||t.isMBSGeoemtryVisible(e,this.view.spatialReference,this._controller.crsIndex)?0:1}};e([n({aliasOf:\"layer\"})],D.prototype,\"i3slayer\",void 0),e([n()],D.prototype,\"suspended\",void 0),e([n(I)],D.prototype,\"updatingProgress\",void 0),e([n({type:u})],D.prototype,\"filter\",null),e([n()],D.prototype,\"viewFilter\",void 0),e([n(q.requiredFields)],D.prototype,\"requiredFields\",null),e([n(q.availableFields)],D.prototype,\"availableFields\",void 0),e([n()],D.prototype,\"fieldsHelper\",void 0),e([n()],D.prototype,\"floorFilterClause\",null),e([n({readOnly:!0,aliasOf:\"view.qualitySettings.sceneService.3dObject.lodFactor\"})],D.prototype,\"lodFactor\",void 0),e([n({readOnly:!0,aliasOf:\"_controller.updatingProgress\"})],D.prototype,\"updatingProgressValue\",void 0),D=e([l(\"esri.views.3d.layers.SceneLayerView3D\")],D);const O=D;export{O as default};\n"],"names":["r","S","p","_","j","h","b","i","s","g","x","a","E","o","d","f","m","C","v","F","w","c","t","y","n","I","u","l"],"mappings":"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"}