import{dJ as v,m as b,es as A,k as m,ci as S,lg as y,dZ as g,d$ as D,gR as h}from"./externalRenderers.e9b2a64d.js";import{c as M,a as p,u as w,m as z}from"./PointCloudWorkerUtil.265051d8.js";import"./PointCloudUniqueValueRenderer.fec2da9f.js";import"./I3SBinaryReader.aa8fb2d6.js";class C{transform(t){const a=this._transform(t),e=[a.points.buffer,a.rgb.buffer];b(a.pointIdFilterMap)&&e.push(a.pointIdFilterMap.buffer);for(const r of a.attributes)"buffer"in r.values&&A(r.values.buffer)&&r.values.buffer!==a.rgb.buffer&&e.push(r.values.buffer);return Promise.resolve({result:a,transferList:e})}_transform(t){const a=M(t.schema,t.geometryBuffer);let e=a.length/3,r=null;const i=[],f=p(t.primaryAttributeData,a,e);b(t.primaryAttributeData)&&f&&i.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:f});const n=p(t.modulationAttributeData,a,e);b(t.modulationAttributeData)&&n&&i.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:n});let s=w(t.rendererInfo,f,n,e);if(t.filterInfo&&t.filterInfo.length>0&&b(t.filterAttributesData)){const o=t.filterAttributesData.map(l=>{const I=p(l,a,e),c={attributeInfo:l.attributeInfo,values:I};return i.push(c),c});r=new Uint32Array(e),e=z(a,s,r,t.filterInfo,o)}for(const o of t.userAttributesData){const l=p(o,a,e);i.push({attributeInfo:o.attributeInfo,values:l})}3*e<s.length&&(s=new Uint8Array(s.buffer.slice(0,3*e))),this._applyElevationOffsetInPlace(a,e,t.elevationOffset);const u=this._transformCoordinates(a,e,t.obb,m.fromJSON(t.inSR),m.fromJSON(t.outSR));return{obb:t.obb,points:u,rgb:s,attributes:i,pointIdFilterMap:r}}_transformCoordinates(t,a,e,r,i){if(!S(t,r,0,t,i,0,a))throw Error("Can't reproject");const f=y(e.center[0],e.center[1],e.center[2]),n=h(),s=h();g(d,e.quaternion);const u=new Float32Array(3*a);for(let o=0;o<a;o++)n[0]=t[3*o]-f[0],n[1]=t[3*o+1]-f[1],n[2]=t[3*o+2]-f[2],D(s,n,d),e.halfSize[0]=Math.max(e.halfSize[0],Math.abs(s[0])),e.halfSize[1]=Math.max(e.halfSize[1],Math.abs(s[1])),e.halfSize[2]=Math.max(e.halfSize[2],Math.abs(s[2])),u[3*o]=n[0],u[3*o+1]=n[1],u[3*o+2]=n[2];return u}_applyElevationOffsetInPlace(t,a,e){if(e!==0)for(let r=0;r<a;r++)t[3*r+2]+=e}}const d=v();function O(){return new C}export{O as default};
//# sourceMappingURL=PointCloudWorker.2abca171.js.map
