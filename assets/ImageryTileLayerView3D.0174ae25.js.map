{"version":3,"file":"ImageryTileLayerView3D.0174ae25.js","sources":["../../node_modules/@arcgis/core/views/layers/ImageryTileLayerView.js","../../node_modules/@arcgis/core/views/3d/layers/ImageryTileLayerView3D.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../Graphic.js\";import r from\"../../core/Error.js\";import{isSome as i,isNone as o}from\"../../core/maybe.js\";import{property as s}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/arrayUtils.js\";import\"../../core/has.js\";import\"../../core/accessorSupport/ensureType.js\";import{subclass as a}from\"../../core/accessorSupport/decorators/subclass.js\";import{combinedViewLayerTimeExtentProperty as n}from\"../../layers/support/commonProperties.js\";import{getDefaultDatumTransformationForDataset as l,projectExtent as u}from\"../../layers/support/rasterFunctions/rasterProjectionHelper.js\";import{getFetchPopupTemplate as p}from\"./support/popupUtils.js\";const m=m=>{let f=class extends m{constructor(){super(...arguments),this._rasterFieldPrefix=\"Raster.\",this.layer=null,this.view=null,this.fullExtent=null,this.tileInfo=null,this.datumTransformation=null}get hasTilingEffects(){return this.layer.renderer&&\"dynamicRangeAdjustment\"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}async fetchPopupFeatures(e,o){const{layer:s}=this;if(!e)return Promise.reject(new r(\"imageryTileLayerView:fetchPopupFeatures\",\"Nothing to fetch without area\",{layer:s}));const{popupEnabled:a}=s,n=p(s,o);if(!a||!i(n))throw new r(\"imageryTileLayerView:fetchPopupFeatures\",\"Missing required popupTemplate or popupEnabled\",{popupEnabled:a,popupTemplate:n});const l=[],{value:u,magdirValue:m}=await s.identify(e,{timeExtent:this.timeExtent});let f=\"\";if(u&&u.length){var c,h;f=\"imagery-tile\"===s.type&&s.hasStandardTime()&&null!=u[0]?u.map((e=>s.getStandardTimeValue(e))).join(\", \"):u.join(\", \");const e={ObjectId:0},r=\"Raster.ServicePixelValue\";e[r]=this._formatAttributeValue(f,r);const i=null==(c=s.rasterInfo)||null==(h=c.attributeTable)?void 0:h.features;if(i&&i.length>0){const t=i.filter((e=>{const t=e.attributes.value||e.attributes.Value||e.attributes.VALUE;return String(t)===f}));if(t.length>0){const r=t[0];if(r)for(const t in r.attributes)if(r.attributes.hasOwnProperty(t)){const i=this._rasterFieldPrefix+t;e[i]=this._formatAttributeValue(r.attributes[t],i)}}}const o=s.rasterInfo.dataType;\"vector-magdir\"!==o&&\"vector-uv\"!==o||(e[\"Raster.Magnitude\"]=null==m?void 0:m[0],e[\"Raster.Direction\"]=null==m?void 0:m[1]);const a=new t(this.fullExtent.clone(),null,e);a.layer=s,a.sourceLayer=a.layer,l.push(a)}return l}updateFullExtent(){const e=this.layer.tileInfo;if(!(e&&e.spatialReference))return Promise.reject(new r(\"layerview:tiling-information-missing\",\"The layer doesn't provide tiling information\",{layer:this.layer}));if(o(this.layer.fullExtent))return Promise.reject(new r(\"layerview:extent-missing\",\"The layer doesn't provide a full extent.\",{layer:this.layer}));const t=l(this.layer.fullExtent,this.view.spatialReference,!1),i=u(this.layer.fullExtent,this.view.spatialReference,t);return null==i?Promise.reject(new r(\"layerview:projection-not-supported\",\"The layer extent cannot be projected to the view's spatial reference\",{layer:this.layer})):(this._set(\"fullExtent\",i),this.datumTransformation||(this.datumTransformation=l(this.layer.fullExtent,this.view.spatialReference,!0)),Promise.resolve())}_formatAttributeValue(e,t){if(\"string\"==typeof e){const r=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,i=this._getFieldInfo(r,t),o=i&&i.format;if(o){let t,r;return e.trim().indexOf(\",\")>-1?(t=\",\",r=t+\" \",this._formatDelimitedString(e,t,r,o)):e.trim().indexOf(\" \")>-1?(t=r=\" \",this._formatDelimitedString(e,t,r,o)):this._formatNumberFromString(e,o)}}return e}_getFieldInfo(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let i;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r&&e.fieldName.toLowerCase()!==r.replace(/ /g,\"_\"))&&(i=e,!0))),i}_formatDelimitedString(e,t,r,i){return e&&t&&r&&i?e.trim().split(t).map((e=>this._formatNumberFromString(e,i))).join(r):e}_formatNumberFromString(e,t){if(!e||!t)return e;const r=Number(e);return isNaN(r)?e:t.format(r)}};return e([s()],f.prototype,\"layer\",void 0),e([s(n)],f.prototype,\"timeExtent\",void 0),e([s()],f.prototype,\"view\",void 0),e([s()],f.prototype,\"fullExtent\",void 0),e([s()],f.prototype,\"tileInfo\",void 0),e([s({readOnly:!0})],f.prototype,\"hasTilingEffects\",null),f=e([a(\"esri.views.layers.ImageryTileLayerView\")],f),f};export{m as ImageryTileLayerView,m as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import{unwrap as r,isNone as t}from\"../../../core/maybe.js\";import{whenTrueOnce as i}from\"../../../core/watchUtils.js\";import{property as s}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/arrayUtils.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as a}from\"../../../core/accessorSupport/decorators/subclass.js\";import{LayerView3D as l}from\"./LayerView3D.js\";import{TiledLayerView3D as o}from\"./TiledLayerView3D.js\";import n from\"../terrain/RasterTile.js\";import{ImageryTileLayerView as m}from\"../../layers/ImageryTileLayerView.js\";import d from\"../../layers/LayerView.js\";import{RefreshableLayerView as h}from\"../../layers/RefreshableLayerView.js\";import{createQueryGeometry as p}from\"../../support/drapedUtils.js\";import y from\"../../webgl/capabilities.js\";let c=class extends(m(h(o(l(d))))){constructor(){super(...arguments),this.type=\"imagery-tile-3d\",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage();const e=this.updateFullExtent();this.addResolvingPromise(e);const r=i(this.view,\"basemapTerrain.tilingSchemeLocked\").then((()=>{const e=this.view.basemapTerrain.tilingScheme,{tileInfo:r}=this.layer,t=[\"png\",\"png24\",\"png32\",\"jpg\",\"mixed\"].indexOf(r.format)>-1&&e.compatibleWith(r);this.isAlignedMapTile=t;const i=t?r:e.toTileInfo();this._set(\"tileInfo\",i),this.updatingHandles.add(this,\"layer.renderer\",(()=>this.refresh())),this.updatingHandles.add(this,\"layer.interpolation\",(()=>this.refresh())),this.updatingHandles.add(this,\"layer.bandIds\",(()=>this.refresh())),this.updatingHandles.add(this,\"layer.multidimensionalDefinition\",(()=>this.refresh()))}));this.addResolvingPromise(r)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const e=document.createElement(\"canvas\"),r=e.getContext(\"2d\"),[t,i]=this.tileInfo.size;return e.width=t,e.height=i,r.clearRect(0,0,t,i),r.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return\"jpg\"===this.layer.tileInfo.format}get hasMixedImageFormats(){return\"mixed\"===this.layer.tileInfo.format}get dataLevelRange(){const e=this.tileInfo.lods,r=this.layer.tileInfo.lods,t=e[0].scale,i=r[r.length-1].scale;return this.levelRangeFromScaleRange(t,i)}async fetchTile(e,i,s,a){const l=this.tileInfo,o=this._canSymbolizeInWebGL(),m={tileInfo:l,requestRawData:o,signal:r(a.signal),requestAsImageElement:this.isAlignedMapTile},d=await this.layer.fetchTile(e,i,s,m);if(d instanceof HTMLImageElement)return d;let h=d&&d.pixelBlock;if(t(h))return this._blankTile;if(!o&&(h=await this.layer.applyRenderer(d),t(h)))return this._blankTile;const p=new n([e,i,s],h,l.size[0],l.size[1]);return o?(p.symbolizerRenderer=this.layer.symbolizer.rendererJSON,p.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e)),p.transformGrid=d.transformGrid):p.isRendereredSource=!0,p.interpolation=this.layer.interpolation,p.bandIds=this.layer.bandIds,p}_getSymbolizerOptions(e){const r=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.spatialReference.isGeographic,resolution:{x:r,y:r},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,r){return p(e,r,this.view)}refresh(){this.emit(\"data-changed\")}async doRefresh(){this.suspended||this.emit(\"data-changed\")}_canSymbolizeInWebGL(){return y().supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL}};e([s({readOnly:!0})],c.prototype,\"_blankTile\",null),e([s({readOnly:!0})],c.prototype,\"imageFormatIsOpaque\",null),e([s({readOnly:!0})],c.prototype,\"hasMixedImageFormats\",null),e([s({readOnly:!0})],c.prototype,\"dataLevelRange\",null),c=e([a(\"esri.views.3d.layers.ImageryTileLayerView3D\")],c);const g=c;export{g as default};\n"],"names":["s","r","p","i","h","t","o","l","u","n","a","d","y"],"mappings":"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"}